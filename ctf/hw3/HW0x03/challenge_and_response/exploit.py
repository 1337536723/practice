#!/usr/bin/env python2
#! -*- coding: utf-8 -*-

from pwn import *
from Crypto.Hash import SHA256

import base64

#IP = '127.0.0.1'
#PORT = 8000

IP = 'csie.ctf.tw'
PORT = 10121
r = remote(IP, PORT)

r.recvrepeat(6)


ID_Nc = 'admin||0'
sha256 = SHA256.new()
sha256.update(ID_Nc)
digest = base64.b64encode(sha256.digest())
r.send(ID_Nc + '||' + digest + '\n')
Ns = r.recvline().split('||')[0]
r.recvrepeat(0.5)

r2 = remote(IP, PORT)
r2.recvrepeat(6)
ID_Nc2 = 'admin||' + Ns
sha256 = SHA256.new()
sha256.update(ID_Nc2)
digest = base64.b64encode(sha256.digest())
r2.send(ID_Nc2 + '||' + digest + '\n')
cipher = r2.recvline().split('||')[1]

r2.recvrepeat(0.5)

sha256 = SHA256.new()
sha256.update(cipher)
digest = base64.b64encode(sha256.digest())

r.send(cipher + '||' + digest + '\n')

print r.recvrepeat(0.5)
