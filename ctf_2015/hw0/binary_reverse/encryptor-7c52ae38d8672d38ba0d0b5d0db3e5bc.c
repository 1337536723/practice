/* This file has been generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2014 Hex-Rays <info@hex-rays.com>

   Detected compiler: GNU C++
*/

#include <defs.h>


//-------------------------------------------------------------------------
// Function declarations

int init_proc();
// void free(void *ptr);
// size_t fread(void *ptr, size_t size, size_t n, FILE *stream);
// int fclose(FILE *stream);
// void *memset(void *s, int c, size_t n);
// __int64 ftell(FILE *stream);
// int __gmon_start__(void); weak
// void *malloc(size_t size);
// int fseek(FILE *stream, __int64 off, int whence);
// FILE *fopen(const char *filename, const char *modes);
// size_t fwrite(const void *ptr, size_t size, size_t n, FILE *s);
int deregister_tm_clones();
int register_tm_clones();
int _do_global_dtors_aux();
int frame_dummy();
__int64 __fastcall encrypt(__int64 a1, int a2);
int __cdecl main(int argc, const char **argv, const char **envp);
int __fastcall _libc_csu_init(unsigned int a1, __int64 a2, __int64 a3);
void term_proc();

//-------------------------------------------------------------------------
// Data declarations

__int64 (__fastcall *_frame_dummy_init_array_entry[2])() = { &frame_dummy, &_do_global_dtors_aux }; // weak
__int64 (__fastcall *_do_global_dtors_aux_fini_array_entry)() = &_do_global_dtors_aux; // weak
char _bss_start; // weak
// extern _UNKNOWN _gmon_start__; weak


//----- (00000000004005A8) ----------------------------------------------------
int init_proc()
{
  _UNKNOWN *v0; // rax@1

  v0 = &_gmon_start__;
  if ( &_gmon_start__ )
    LODWORD(v0) = __gmon_start__();
  return (signed int)v0;
}
// 400640: using guessed type int __gmon_start__(void);

//----- (0000000000400690) ----------------------------------------------------
#error "400696: positive sp value has been found (funcsize=3)"

//----- (00000000004006C0) ----------------------------------------------------
int deregister_tm_clones()
{
  signed __int64 v0; // rax@1

  v0 = 6295687LL - (_QWORD)&_bss_start;
  if ( (unsigned __int64)(6295687LL - (_QWORD)&_bss_start) > 0xE )
    LODWORD(v0) = 0;
  return v0;
}
// 601080: using guessed type char _bss_start;

//----- (00000000004006F0) ----------------------------------------------------
int register_tm_clones()
{
  return (signed __int64)(((unsigned __int64)(6295680LL - (_QWORD)&_bss_start) >> 63)
                        + ((6295680 - (signed __int64)&_bss_start) >> 3)) >> 1;
}
// 601080: using guessed type char _bss_start;

//----- (0000000000400730) ----------------------------------------------------
int _do_global_dtors_aux()
{
  int result; // eax@2

  if ( !_bss_start )
  {
    result = deregister_tm_clones();
    _bss_start = 1;
  }
  return result;
}
// 601080: using guessed type char _bss_start;

//----- (0000000000400750) ----------------------------------------------------
int frame_dummy()
{
  return register_tm_clones();
}
// 400750: could not find valid save-restore pair for rbp

//----- (000000000040077D) ----------------------------------------------------
__int64 __fastcall encrypt(__int64 a1, int a2)
{
  __int64 result; // rax@5
  int v3; // [sp+14h] [bp-18h]@2
  int i; // [sp+18h] [bp-14h]@1
  int *v5; // [sp+1Ch] [bp-10h]@2
  __int64 v6; // [sp+24h] [bp-8h]@2

  for ( i = 0; ; ++i )
  {
    result = (unsigned int)i;
    if ( i >= a2 )
      break;
    v3 = *(_DWORD *)(4LL * i + a1);
    v5 = &v3;
    v6 = 4LL * i + a1;
    *(_BYTE *)v6 = BYTE2(v3) ^ BYTE1(v3) ^ v3;
    *(_BYTE *)(v6 + 1) = *((_BYTE *)v5 + 1) ^ *((_BYTE *)v5 + 3);
    *(_BYTE *)(v6 + 2) = *(_BYTE *)v5 ^ *((_BYTE *)v5 + 2);
    *(_BYTE *)(v6 + 3) = *(_BYTE *)v5 ^ *((_BYTE *)v5 + 1);
    if ( a2 - 1 > i )
      *(_DWORD *)(4LL * i + a1) ^= ~*(_DWORD *)(4 * (i + 1LL) + a1);
  }
  return result;
}

//----- (00000000004008BB) ----------------------------------------------------
int __cdecl main(int argc, const char **argv, const char **envp)
{
  int result; // eax@2
  int v4; // ST18_4@3
  signed int v5; // ST1C_4@3
  void *ptr; // ST28_8@3
  FILE *v7; // ST20_8@3
  FILE *stream; // [sp+20h] [bp-10h]@1

  stream = fopen(argv[1], "rb");
  if ( stream )
  {
    fseek(stream, 0LL, 2);
    v4 = ftell(stream); // file size
    v5 = (v4 & 0xFFFFFFFC) + 4;
    fseek(stream, 0LL, 0);
    ptr = malloc(v5);
    fread(ptr, v4, 1uLL, stream);
    memset((char *)ptr + v4, v5 - v4, v5 - v4);
    encrypt((__int64)ptr, v5 / 4);
    fclose(stream);
    v7 = fopen(argv[2], "wb");
    fwrite(ptr, v5, 1uLL, v7);
    fclose(v7);
    free(ptr);
    result = 0;
  }
  else
  {
    result = 0;
  }
  return result;
}

//----- (0000000000400A20) ----------------------------------------------------
int __fastcall _libc_csu_init(unsigned int a1, __int64 a2, __int64 a3)
{
  __int64 v3; // r13@1
  __int64 v4; // rbx@1
  signed __int64 v5; // rbp@1
  int result; // eax@1

  v3 = a3;
  v4 = 0LL;
  v5 = &_do_global_dtors_aux_fini_array_entry - _frame_dummy_init_array_entry;
  result = init_proc();
  if ( v5 )
  {
    do
      result = ((int (__fastcall *)(_QWORD, __int64, __int64))_frame_dummy_init_array_entry[v4++])(a1, a2, v3);
    while ( v4 != v5 );
  }
  return result;
}
// 600E10: using guessed type __int64 (__fastcall *_frame_dummy_init_array_entry[2])();
// 600E18: using guessed type __int64 (__fastcall *_do_global_dtors_aux_fini_array_entry)();

//----- (0000000000400A94) ----------------------------------------------------
void term_proc()
{
  ;
}

#error "There were 1 decompilation failure(s) on 10 function(s)"
